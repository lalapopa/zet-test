# Про IPv4

Протокол находится на сетевом уровне OSI модели.

## Заголовок (Header) IPv4 

1. (0-3) **Ver**

Отвечает за версию (IPv4 или IPv6). Заголовок у IPv6 другой. 
1. (4-7) **IHL**

Длина заголовка в IP пакете. Нужен для определения границы заголовка и Options.
Содержит длину пакета в 4-ех байтных словах. 5 полей по 32 бита обязательны.

1. (8-13) **DSCP** (QoS)

Значение DSCP (Differentiated Services Code Point) --- приоритет данных.

1. (14-15) **ECN**

ECN (Explicit Congestion Notification) --- указывает на перегрузку сети.

1. (16-31) **Total length**

Общая длина IP пакета. Общая длина IP пакета может быть 64 Кбайта (В реальности 
меньше). 

1. (2 byte) **Ident**

Идентификатор --- каждому пакету назначается уникальный идентификатор, нужен для
фрагметации.

1. (3 bit) **Flags**

Флаги, их два. Первый бит зарезервирован. 

Второй бит флаг DF (Don't Fragment) --- если стоит такой флаг значит пакет
будет отброшен, если нужно будет фрагментировать. 

Третий бит флаг MF (More Fragments) --- такой флаг поднимается если фрагмент, не
последний. Все фрагменты с первого и предпоследнего имеют такой фрагмент.

1. (13 bit) **Fragment Offset**

Смещение фрагмента относительно исходного пакета. Мерится в 8-байтовых словах.

1. (1 byte) **TTL**

TTL (Time to live) --- изначально было как время которое пакет может провести в
сети. Сейчас понимается как количество хопов (L3 хопы), на которое может быть
передан. Проходя через роутер уменьшается на 1. Нужен для того, чтобы при
возникновении ошибок маршрутизации пакеты вечно не бегали по сети и пакеты при 
не положительном TTL отбрасываются.

1. (1 byte) **Protocol** 

Указание на протокол вышележащего уровня (Транспортный).

1. (2 byte) **Header Checksum** 

У протоколов транспортного уровня они тоже есть. При получении роутером каждый 
раз пересчитывается.

1. (4 byte) **Source Address**

Адреса, которые вводит протокол IPv4.

1. (4 byte) **Destination Address**

1. () **Options**

Чаще не бывает. Обычно пакеты с опциями не проходят.

1. () **Data**

До Options --- считается заголовком. До Destination Address обязательная часть
заголовка. Длина заголовка 20 byte минимум. 

При соединении отправителя и получателя напрямую кабелем. Данные отправителя 
проходят 7 уровней OSI, преобразуются в биты и передаются в битовом виде
получателю, где происходит обратная процедура (декапсуляция).

Если будет между О и П устройство первого уровня (повторитель или хаб). Данные
обрабатываются у этого устройства на первом уровне. Работает с битами. 

Если будет бридж или свитч или комутатор (устройство второго уровня).
Анализирует frame.

Если будет устройство третьего уровня (роутер). Данные поднимаются до 3-его
уровня из битов получает фрейм и на втором уровне работет с фреймом (проверка
контрольной суммы, адрес получателя), далее из фрейма извлекается IP пакет и 
проверка контрольной суммы, уменьшение TTL. И дальше пакет инкапсулируются в новый 
фрейм и отправляется дальше.

## Использование разных канальных протоколов на разных интерфейсах маршрутизации 

> MTU --- maximum transmission unit.  

Отправитель отправляет с MTU меньше чем на интерфейсах. Но может быть 
такое, что MTU у получателя меньше чем у отправителя. То такие пакеты не пролезут.   
Чтобы решить проблему, выполняют фрагментацию пакета.

Устройство (Роутер, файервол) нарезает на два или больше фрагметов. Как это
описано у  Олифера  --- это не так. Сетевое оборудование делит фрагменты по 
максимуму MTU + что останется.

Каждый фрагмент нарезается по принципу указанному выше. В каждый фргамент
дается заголовок IP пакета, как родительский. По полю Ident принимающий понимает
какой фрагмент относится к какому. Fragment offset --- смещение пакета
относительно начального пакета. По полю Flags и значение 0 в MF, то понимается
что все фрагменты пришли. Сборка фрагментов в пакет происходит у получателя
(кроме файерволов), а фрагментация на всем пути.

Tags:

    #основы компьютерный сетей
